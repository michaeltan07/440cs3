---
title: "440cs3_ir2"
author: "Jake Epstein, Man-Lin Hsiao, Sahil Patel, Daniel Spotiswood, & Michael Tan"
date: "10/16/2019"
output: html_document
---

```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(lme4)
library(sjPlot)
library(brms)

select = dplyr::select
```

```{r, echo=FALSE}
#read in mortality
mortality = read.csv("nc_infant_mortality.csv") %>%
  mutate(COUNTY = str_remove_all(COUNTY, " "))

 
mortality$COUNTY[which(mortality$COUNTY == "McDOWELL")] = "MCDOWELL"
mortality$COUNTY[which(mortality$COUNTY == "TYRELL")] = "TYRRELL"

demos = read.csv("Data/County_Demo_Data.csv")
demos.clean = demos %>%
  mutate(COUNTY = toupper(COUNTY) %>% str_remove_all(" "))

mortality = merge(mortality , demos.clean, by = "COUNTY")
```


```{r, echo=FALSE}
# replicate 2015 SCHS table exactly
SCHS_Table_2015 = mortality %>%
  mutate(race = relevel(race, "White")) %>%
  filter(YOB == 2015) %>%
  select(mortality, race, COUNTY, deaths) %>%
  mutate(smallSample = deaths < 10) %>%
  select(-deaths, -smallSample) %>%
  spread(race, mortality)
```

### EDA
```{r, echo=FALSE}
#Drop Clay outlier for plots
eda=mortality%>%
  filter(mortality<1000)
```

```{r, echo=FALSE}
#Median income
cor1=cor(eda$Median_Household_Income,eda$mortality)
ggplot(eda)+
  aes(x=Median_Household_Income,y=mortality)+
  geom_point()+
  geom_smooth(method=lm)
```
As illustrated by the scatter plot above, there is distinct negative relationship between the median income of a county and the mortality rate in that county. Specifically, the two variables have a negative correlation of `r cor1`. This implies that counties with higher median income tend to have lower mortatility rates. XXX

```{r, echo=FALSE}
#Low birth weight
cor2=cor(eda$pctLowBirthWeight,eda$mortality)
ggplot(eda)+
  aes(x=pctLowBirthWeight,y=mortality)+
  geom_point()+
  geom_smooth(method=lm)
```
As illustrated by the scatter plot above, there is distinct negative relationship between the percent of births that had a low birth weight in a county and the mortality rate in that county. Specifically, the two variables have a positive correlation of `r cor2`. This implies that counties with a percent of births that had a low birth weight tend to have lower mortatility rates. XXX

```{r, echo=FALSE}
#Percent Smoke
cor3=cor(eda$pctSmokers,eda$mortality)
ggplot(eda)+
  aes(x=pctSmokers,y=mortality)+
  geom_point()+
  geom_smooth(method=lm)
```
As illustrated by the scatter plot above, there is distinct negative relationship between the proportion of a county that smokes and the mortality rate in that county. Specifically, the two variables have a negative correlation of `r cor3`. This implies that counties with more smokers tend to have lower mortatility rates. XXX

```{r, echo=FALSE}
mortality = mortality %>%
  mutate(mortality_rate = mortality / 1000, race = relevel(race, "White")) %>%
  mutate(Median_Household_Income = Median_Household_Income / 1000)

model = glmer(data = mortality, weights = births, formula = mortality_rate ~ (1|COUNTY) + (1|race) + Median_Household_Income + pctLowBirthWeight + pctSmokers, family = binomial())

summary(model)
plot_model(model)

plot_model(model, type = "re") 
plot_model(model, type = "est") 


```



### Compare our fitted values to the predictions from the schs table
```{r, echo=FALSE, warning=FALSE}
mortality_fitted = mortality
mortality_fitted$fitted.values = fitted(model)


our_table = mortality_fitted %>%
  filter(YOB == 2015) %>%
  select(fitted.values, race, COUNTY) %>%
  mutate(predicted_mortality = 1000*fitted.values) %>%
  select(-fitted.values) %>%
  spread(race, predicted_mortality)


our_table_as_list = mortality_fitted %>%
  select(COUNTY, race, fitted.values) %>%
  mutate(predicted_mortality = 1000*fitted.values) %>%
  select(-fitted.values)

schs_table_as_list = SCHS_Table_2015 %>%
  gather(race, mortality, 2:length(SCHS_Table_2015)) %>%
  na.omit()

table_comparisons = merge(our_table, SCHS_Table_2015, by = "COUNTY")

comparisons = merge(our_table_as_list, schs_table_as_list, by = c("race", "COUNTY"))

comparisons = merge(comparisons, mortality %>% filter(YOB == 2015))

comparisons = comparisons %>%
  mutate(difference = mortality - predicted_mortality)

ggplot(comparisons, aes(x = predicted_mortality, y = mortality)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  xlab ("Predicted Values") +
  ylab ("Reported Values") +
  theme_minimal()

ggplot(comparisons, aes(x = predicted_mortality, y = mortality)) +
  geom_point() +
  ylim(c(0, 100)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab ("Predicted Values") +
  ylab ("Reported Values") +
  theme_minimal()

ggplot(comparisons, aes(x = births, y = difference)) +
  geom_point() +
  ylim(c(-10, 100)) +
  xlab("Number of Births") +
  ylab("Difference in Predicted vs Reported Mortalities") +
  theme_minimal()


```






